import UIKit
import Network
import Combine

class ViewController: UIViewController {
    
    // MARK: - UI Elements
    private let scrollView = UIScrollView()
    private let contentView = UIView()
    
    private let titleLabel = UILabel()
    private let statusLabel = UILabel()
    
    // TV Code Input Section
    private let tvCodeHeaderLabel = UILabel()
    private let tvCodeTextField = UITextField()
    private let connectWithCodeButton = UIButton(type: .system)
    private let scanDevicesButton = UIButton(type: .system)
    
    private let devicesHeaderLabel = UILabel()
    private let devicesStackView = UIStackView()
    
    private let settingsHeaderLabel = UILabel()
    private let autoSkipSwitch = UISwitch()
    private let muteAdsSwitch = UISwitch()
    private let skipCategoriesStackView = UIStackView()
    
    private let statisticsHeaderLabel = UILabel()
    private let skippedCountLabel = UILabel()
    private let savedTimeLabel = UILabel()
    private let activeVideoLabel = UILabel()
    
    // MARK: - Properties
    private let youTubeTVManager = YouTubeTVManager.shared
    private var skippedSegments = 0
    private var timeSaved = 0
    private var cancellables = Set<AnyCancellable>()
    
    override func viewDidLoad() {
        super.viewDidLoad()
        setupUI()
        setupConstraints()
        setupObservers()
        loadSettings()
    }
    
    private func setupObservers() {
        // –ù–∞–±–ª—é–¥–∞–µ–º –∑–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏ –≤ YouTubeTVManager
        youTubeTVManager.$connectionStatus
            .receive(on: DispatchQueue.main)
            .sink { [weak self] status in
                self?.updateConnectionStatus(status)
            }
            .store(in: &cancellables)
        
        youTubeTVManager.$connectedDevices
            .receive(on: DispatchQueue.main)
            .sink { [weak self] devices in
                self?.updateDevicesList(devices)
            }
            .store(in: &cancellables)
        
        youTubeTVManager.$isScanning
            .receive(on: DispatchQueue.main)
            .sink { [weak self] isScanning in
                self?.scanDevicesButton.isEnabled = !isScanning
                self?.scanDevicesButton.setTitle(isScanning ? "–ü–æ–∏—Å–∫..." : "–°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å —Å–µ—Ç—å", for: .normal)
            }
            .store(in: &cancellables)
    }
    
    // MARK: - UI Setup
    private func setupUI() {
        view.backgroundColor = .systemBackground
        title = "iSponsorBlockTV"
        
        // Scroll view setup
        scrollView.translatesAutoresizingMaskIntoConstraints = false
        contentView.translatesAutoresizingMaskIntoConstraints = false
        view.addSubview(scrollView)
        scrollView.addSubview(contentView)
        
        // Title
        titleLabel.text = "üì∫ iSponsorBlockTV"
        titleLabel.font = UIFont.boldSystemFont(ofSize: 28)
        titleLabel.textAlignment = .center
        titleLabel.translatesAutoresizingMaskIntoConstraints = false
        contentView.addSubview(titleLabel)
        
        // Status
        statusLabel.text = "–ù–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º"
        statusLabel.font = UIFont.systemFont(ofSize: 16)
        statusLabel.textAlignment = .center
        statusLabel.textColor = .systemGray
        statusLabel.translatesAutoresizingMaskIntoConstraints = false
        contentView.addSubview(statusLabel)
        
        // TV Code Section
        tvCodeHeaderLabel.text = "–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ YouTube TV"
        tvCodeHeaderLabel.font = UIFont.boldSystemFont(ofSize: 20)
        tvCodeHeaderLabel.translatesAutoresizingMaskIntoConstraints = false
        contentView.addSubview(tvCodeHeaderLabel)
        
        // Instructions label
        let instructionsLabel = UILabel()
        instructionsLabel.text = "1. –û—Ç–∫—Ä–æ–π—Ç–µ YouTube –Ω–∞ –≤–∞—à–µ–º TV\n2. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ ‚Üí –°–≤—è–∑–∞—Ç—å —Å —Ç–µ–ª–µ—Ñ–æ–Ω–æ–º\n3. –í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –Ω–∏–∂–µ:"
        instructionsLabel.font = UIFont.systemFont(ofSize: 14)
        instructionsLabel.textColor = .systemGray
        instructionsLabel.numberOfLines = 0
        instructionsLabel.translatesAutoresizingMaskIntoConstraints = false
        contentView.addSubview(instructionsLabel)
        
        // TV Code input
        tvCodeTextField.placeholder = "–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ —Å —Ç–µ–ª–µ–≤–∏–∑–æ—Ä–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä: ABC-XYZ-123)"
        tvCodeTextField.borderStyle = .roundedRect
        tvCodeTextField.autocapitalizationType = .allCharacters
        tvCodeTextField.font = UIFont.systemFont(ofSize: 18)
        tvCodeTextField.textAlignment = .center
        tvCodeTextField.translatesAutoresizingMaskIntoConstraints = false
        contentView.addSubview(tvCodeTextField)
        
        // Connect with code button
        connectWithCodeButton.setTitle("–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ TV", for: .normal)
        connectWithCodeButton.backgroundColor = .systemBlue
        connectWithCodeButton.setTitleColor(.white, for: .normal)
        connectWithCodeButton.layer.cornerRadius = 8
        connectWithCodeButton.titleLabel?.font = UIFont.boldSystemFont(ofSize: 18)
        connectWithCodeButton.addTarget(self, action: #selector(connectWithCodeTapped), for: .touchUpInside)
        connectWithCodeButton.translatesAutoresizingMaskIntoConstraints = false
        contentView.addSubview(connectWithCodeButton)
        
        // Scan devices button
        scanDevicesButton.setTitle("–°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å —Å–µ—Ç—å", for: .normal)
        scanDevicesButton.backgroundColor = .systemOrange
        scanDevicesButton.setTitleColor(.white, for: .normal)
        scanDevicesButton.layer.cornerRadius = 8
        scanDevicesButton.titleLabel?.font = UIFont.systemFont(ofSize: 16)
        scanDevicesButton.addTarget(self, action: #selector(scanDevicesTapped), for: .touchUpInside)
        scanDevicesButton.translatesAutoresizingMaskIntoConstraints = false
        contentView.addSubview(scanDevicesButton)
        
        // Devices section
        devicesHeaderLabel.text = "–ü–æ–¥–∫–ª—é—á–µ–Ω–Ω—ã–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞"
        devicesHeaderLabel.font = UIFont.boldSystemFont(ofSize: 20)
        devicesHeaderLabel.translatesAutoresizingMaskIntoConstraints = false
        contentView.addSubview(devicesHeaderLabel)
        
        devicesStackView.axis = .vertical
        devicesStackView.spacing = 8
        devicesStackView.translatesAutoresizingMaskIntoConstraints = false
        contentView.addSubview(devicesStackView)
        
        // Settings section
        settingsHeaderLabel.text = "–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏"
        settingsHeaderLabel.font = UIFont.boldSystemFont(ofSize: 20)
        settingsHeaderLabel.translatesAutoresizingMaskIntoConstraints = false
        contentView.addSubview(settingsHeaderLabel)
        
        // Auto skip setting
        let autoSkipStack = createSettingRow(
            title: "–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø—Ä–æ–ø—É—Å–∫",
            subtitle: "–ü—Ä–æ–ø—É—Å–∫–∞—Ç—å —Å–ø–æ–Ω—Å–æ—Ä—Å–∫–∏–µ —Å–µ–≥–º–µ–Ω—Ç—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏",
            switchControl: autoSkipSwitch
        )
        contentView.addSubview(autoSkipStack)
        
        // Mute ads setting
        let muteAdsStack = createSettingRow(
            title: "–ó–∞–≥–ª—É—à–∞—Ç—å —Ä–µ–∫–ª–∞–º—É",
            subtitle: "–û—Ç–∫–ª—é—á–∞—Ç—å –∑–≤—É–∫ –≤–æ –≤—Ä–µ–º—è —Ä–µ–∫–ª–∞–º–Ω—ã—Ö —Ä–æ–ª–∏–∫–æ–≤",
            switchControl: muteAdsSwitch
        )
        contentView.addSubview(muteAdsStack)
        
        // Skip categories
        let categoriesLabel = UILabel()
        categoriesLabel.text = "–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –¥–ª—è –ø—Ä–æ–ø—É—Å–∫–∞:"
        categoriesLabel.font = UIFont.systemFont(ofSize: 16)
        categoriesLabel.translatesAutoresizingMaskIntoConstraints = false
        contentView.addSubview(categoriesLabel)
        
        skipCategoriesStackView.axis = .vertical
        skipCategoriesStackView.spacing = 8
        skipCategoriesStackView.translatesAutoresizingMaskIntoConstraints = false
        contentView.addSubview(skipCategoriesStackView)
        
        // Create category switches
        let categories = [
            ("sponsor", "–°–ø–æ–Ω—Å–æ—Ä—Å–∫–∏–µ —Å–µ–≥–º–µ–Ω—Ç—ã"),
            ("intro", "–í—Å—Ç—É–ø–ª–µ–Ω–∏—è"),
            ("outro", "–ö–æ–Ω—Ü–æ–≤–∫–∏"),
            ("interaction", "–ü—Ä–∏–∑—ã–≤—ã –∫ –¥–µ–π—Å—Ç–≤–∏—é"),
            ("selfpromo", "–°–∞–º–æ—Ä–µ–∫–ª–∞–º—ã")
        ]
        
        for (category, title) in categories {
            let categorySwitch = UISwitch()
            categorySwitch.isOn = true
            categorySwitch.tag = categories.firstIndex(where: { $0.0 == category }) ?? 0
            
            let categoryStack = createSettingRow(
                title: title,
                subtitle: "",
                switchControl: categorySwitch
            )
            skipCategoriesStackView.addArrangedSubview(categoryStack)
        }
        
        // Statistics section
        statisticsHeaderLabel.text = "üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å"
        statisticsHeaderLabel.font = UIFont.boldSystemFont(ofSize: 20)
        statisticsHeaderLabel.translatesAutoresizingMaskIntoConstraints = false
        contentView.addSubview(statisticsHeaderLabel)
        
        activeVideoLabel.text = "–¢–µ–∫—É—â–µ–µ –≤–∏–¥–µ–æ: –ù–µ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—Å—è"
        activeVideoLabel.font = UIFont.systemFont(ofSize: 14)
        activeVideoLabel.textColor = .systemGray
        activeVideoLabel.numberOfLines = 2
        activeVideoLabel.translatesAutoresizingMaskIntoConstraints = false
        contentView.addSubview(activeVideoLabel)
        
        skippedCountLabel.text = "–ü—Ä–æ–ø—É—â–µ–Ω–æ —Å–µ–≥–º–µ–Ω—Ç–æ–≤: 0"
        skippedCountLabel.font = UIFont.systemFont(ofSize: 16)
        skippedCountLabel.translatesAutoresizingMaskIntoConstraints = false
        contentView.addSubview(skippedCountLabel)
        
        savedTimeLabel.text = "–°—ç–∫–æ–Ω–æ–º–ª–µ–Ω–æ –≤—Ä–µ–º–µ–Ω–∏: 0 –º–∏–Ω"
        savedTimeLabel.font = UIFont.systemFont(ofSize: 16)
        savedTimeLabel.translatesAutoresizingMaskIntoConstraints = false
        contentView.addSubview(savedTimeLabel)
        
        // Add switch targets
        autoSkipSwitch.addTarget(self, action: #selector(settingChanged), for: .valueChanged)
        muteAdsSwitch.addTarget(self, action: #selector(settingChanged), for: .valueChanged)
    }
    }
    
    private func createSettingRow(title: String, subtitle: String, switchControl: UISwitch) -> UIStackView {
        let mainStack = UIStackView()
        mainStack.axis = .horizontal
        mainStack.alignment = .center
        mainStack.spacing = 16
        mainStack.translatesAutoresizingMaskIntoConstraints = false
        
        let labelsStack = UIStackView()
        labelsStack.axis = .vertical
        labelsStack.spacing = 4
        
        let titleLabel = UILabel()
        titleLabel.text = title
        titleLabel.font = UIFont.boldSystemFont(ofSize: 16)
        
        let subtitleLabel = UILabel()
        subtitleLabel.text = subtitle
        subtitleLabel.font = UIFont.systemFont(ofSize: 14)
        subtitleLabel.textColor = .systemGray
        subtitleLabel.numberOfLines = 0
        
        labelsStack.addArrangedSubview(titleLabel)
        labelsStack.addArrangedSubview(subtitleLabel)
        
        switchControl.translatesAutoresizingMaskIntoConstraints = false
        
        mainStack.addArrangedSubview(labelsStack)
        mainStack.addArrangedSubview(switchControl)
        
        return mainStack
    }
    
    private func setupConstraints() {
        // –ù–∞—Ö–æ–¥–∏–º —ç–ª–µ–º–µ–Ω—Ç—ã –¥–ª—è —Ä–∞—Å—Å—Ç–∞–Ω–æ–≤–∫–∏ constraints
        let instructionsLabel = contentView.subviews.first { $0 is UILabel && ($0 as! UILabel).text?.contains("–û—Ç–∫—Ä–æ–π—Ç–µ YouTube") == true }!
        let categoriesLabel = contentView.subviews.first { $0 is UILabel && ($0 as! UILabel).text?.contains("–ö–∞—Ç–µ–≥–æ—Ä–∏–∏") == true }!
        let autoSkipStack = contentView.subviews.first { $0 is UIStackView && $0 != devicesStackView && $0 != skipCategoriesStackView }!
        let muteAdsStack = contentView.subviews.dropFirst().first { $0 is UIStackView && $0 != devicesStackView && $0 != skipCategoriesStackView && $0 != autoSkipStack }!
        
        NSLayoutConstraint.activate([
            // Scroll view
            scrollView.topAnchor.constraint(equalTo: view.safeAreaLayoutGuide.topAnchor),
            scrollView.leadingAnchor.constraint(equalTo: view.leadingAnchor),
            scrollView.trailingAnchor.constraint(equalTo: view.trailingAnchor),
            scrollView.bottomAnchor.constraint(equalTo: view.bottomAnchor),
            
            // Content view
            contentView.topAnchor.constraint(equalTo: scrollView.topAnchor),
            contentView.leadingAnchor.constraint(equalTo: scrollView.leadingAnchor),
            contentView.trailingAnchor.constraint(equalTo: scrollView.trailingAnchor),
            contentView.bottomAnchor.constraint(equalTo: scrollView.bottomAnchor),
            contentView.widthAnchor.constraint(equalTo: scrollView.widthAnchor),
            
            // Title
            titleLabel.topAnchor.constraint(equalTo: contentView.topAnchor, constant: 20),
            titleLabel.leadingAnchor.constraint(equalTo: contentView.leadingAnchor, constant: 20),
            titleLabel.trailingAnchor.constraint(equalTo: contentView.trailingAnchor, constant: -20),
            
            // Status
            statusLabel.topAnchor.constraint(equalTo: titleLabel.bottomAnchor, constant: 16),
            statusLabel.leadingAnchor.constraint(equalTo: contentView.leadingAnchor, constant: 20),
            statusLabel.trailingAnchor.constraint(equalTo: contentView.trailingAnchor, constant: -20),
            
            // TV Code Header
            tvCodeHeaderLabel.topAnchor.constraint(equalTo: statusLabel.bottomAnchor, constant: 30),
            tvCodeHeaderLabel.leadingAnchor.constraint(equalTo: contentView.leadingAnchor, constant: 20),
            tvCodeHeaderLabel.trailingAnchor.constraint(equalTo: contentView.trailingAnchor, constant: -20),
            
            // Instructions
            instructionsLabel.topAnchor.constraint(equalTo: tvCodeHeaderLabel.bottomAnchor, constant: 12),
            instructionsLabel.leadingAnchor.constraint(equalTo: contentView.leadingAnchor, constant: 20),
            instructionsLabel.trailingAnchor.constraint(equalTo: contentView.trailingAnchor, constant: -20),
            
            // TV Code input
            tvCodeTextField.topAnchor.constraint(equalTo: instructionsLabel.bottomAnchor, constant: 16),
            tvCodeTextField.leadingAnchor.constraint(equalTo: contentView.leadingAnchor, constant: 20),
            tvCodeTextField.trailingAnchor.constraint(equalTo: contentView.trailingAnchor, constant: -20),
            tvCodeTextField.heightAnchor.constraint(equalToConstant: 50),
            
            // Connect with code button
            connectWithCodeButton.topAnchor.constraint(equalTo: tvCodeTextField.bottomAnchor, constant: 16),
            connectWithCodeButton.leadingAnchor.constraint(equalTo: contentView.leadingAnchor, constant: 20),
            connectWithCodeButton.trailingAnchor.constraint(equalTo: contentView.trailingAnchor, constant: -20),
            connectWithCodeButton.heightAnchor.constraint(equalToConstant: 50),
            
            // Scan devices button
            scanDevicesButton.topAnchor.constraint(equalTo: connectWithCodeButton.bottomAnchor, constant: 12),
            scanDevicesButton.leadingAnchor.constraint(equalTo: contentView.leadingAnchor, constant: 20),
            scanDevicesButton.trailingAnchor.constraint(equalTo: contentView.trailingAnchor, constant: -20),
            scanDevicesButton.heightAnchor.constraint(equalToConstant: 44),
            
            // Devices header
            devicesHeaderLabel.topAnchor.constraint(equalTo: scanDevicesButton.bottomAnchor, constant: 30),
            devicesHeaderLabel.leadingAnchor.constraint(equalTo: contentView.leadingAnchor, constant: 20),
            devicesHeaderLabel.trailingAnchor.constraint(equalTo: contentView.trailingAnchor, constant: -20),
            
            // Devices stack
            devicesStackView.topAnchor.constraint(equalTo: devicesHeaderLabel.bottomAnchor, constant: 16),
            devicesStackView.leadingAnchor.constraint(equalTo: contentView.leadingAnchor, constant: 20),
            devicesStackView.trailingAnchor.constraint(equalTo: contentView.trailingAnchor, constant: -20),
            
            // Settings header
            settingsHeaderLabel.topAnchor.constraint(equalTo: devicesStackView.bottomAnchor, constant: 30),
            settingsHeaderLabel.leadingAnchor.constraint(equalTo: contentView.leadingAnchor, constant: 20),
            settingsHeaderLabel.trailingAnchor.constraint(equalTo: contentView.trailingAnchor, constant: -20),
            
            // Settings stacks
            autoSkipStack.topAnchor.constraint(equalTo: settingsHeaderLabel.bottomAnchor, constant: 16),
            autoSkipStack.leadingAnchor.constraint(equalTo: contentView.leadingAnchor, constant: 20),
            autoSkipStack.trailingAnchor.constraint(equalTo: contentView.trailingAnchor, constant: -20),
            
            muteAdsStack.topAnchor.constraint(equalTo: autoSkipStack.bottomAnchor, constant: 16),
            muteAdsStack.leadingAnchor.constraint(equalTo: contentView.leadingAnchor, constant: 20),
            muteAdsStack.trailingAnchor.constraint(equalTo: contentView.trailingAnchor, constant: -20),
            
            // Categories label
            categoriesLabel.topAnchor.constraint(equalTo: muteAdsStack.bottomAnchor, constant: 20),
            categoriesLabel.leadingAnchor.constraint(equalTo: contentView.leadingAnchor, constant: 20),
            categoriesLabel.trailingAnchor.constraint(equalTo: contentView.trailingAnchor, constant: -20),
            
            // Skip categories stack
            skipCategoriesStackView.topAnchor.constraint(equalTo: categoriesLabel.bottomAnchor, constant: 12),
            skipCategoriesStackView.leadingAnchor.constraint(equalTo: contentView.leadingAnchor, constant: 20),
            skipCategoriesStackView.trailingAnchor.constraint(equalTo: contentView.trailingAnchor, constant: -20),
            
            // Statistics header
            statisticsHeaderLabel.topAnchor.constraint(equalTo: skipCategoriesStackView.bottomAnchor, constant: 30),
            statisticsHeaderLabel.leadingAnchor.constraint(equalTo: contentView.leadingAnchor, constant: 20),
            statisticsHeaderLabel.trailingAnchor.constraint(equalTo: contentView.trailingAnchor, constant: -20),
            
            // Statistics labels
            activeVideoLabel.topAnchor.constraint(equalTo: statisticsHeaderLabel.bottomAnchor, constant: 16),
            activeVideoLabel.leadingAnchor.constraint(equalTo: contentView.leadingAnchor, constant: 20),
            activeVideoLabel.trailingAnchor.constraint(equalTo: contentView.trailingAnchor, constant: -20),
            
            skippedCountLabel.topAnchor.constraint(equalTo: activeVideoLabel.bottomAnchor, constant: 12),
            skippedCountLabel.leadingAnchor.constraint(equalTo: contentView.leadingAnchor, constant: 20),
            skippedCountLabel.trailingAnchor.constraint(equalTo: contentView.trailingAnchor, constant: -20),
            
            savedTimeLabel.topAnchor.constraint(equalTo: skippedCountLabel.bottomAnchor, constant: 8),
            savedTimeLabel.leadingAnchor.constraint(equalTo: contentView.leadingAnchor, constant: 20),
            savedTimeLabel.trailingAnchor.constraint(equalTo: contentView.trailingAnchor, constant: -20),
            savedTimeLabel.bottomAnchor.constraint(equalTo: contentView.bottomAnchor, constant: -30)
        ])
    }
    
    // MARK: - Actions
    @objc private func connectWithCodeTapped() {
        guard let code = tvCodeTextField.text?.trimmingCharacters(in: .whitespacesAndNewlines),
              !code.isEmpty else {
            showAlert(title: "–û—à–∏–±–∫–∞", message: "–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ —Å —Ç–µ–ª–µ–≤–∏–∑–æ—Ä–∞")
            return
        }
        
        // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –∫–æ–¥ –≤ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç
        let cleanCode = code.replacingOccurrences(of: "-", with: "").uppercased()
        youTubeTVManager.connectWithTVCode(cleanCode)
        
        // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞
        tvCodeTextField.text = ""
        view.endEditing(true)
    }
    
    @objc private func scanDevicesTapped() {
        youTubeTVManager.startDeviceDiscovery()
    }
    
    @objc private func settingChanged() {
        saveSettings()
        updateYouTubeTVSettings()
    }
    
    private func updateYouTubeTVSettings() {
        // –û–±–Ω–æ–≤–ª—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ YouTubeTVManager
        var settings = YouTubeTVSettings.shared
        settings.autoSkipEnabled = autoSkipSwitch.isOn
        settings.muteAdsEnabled = muteAdsSwitch.isOn
        
        // –°–æ–±–∏—Ä–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
        var selectedCategories: [String] = []
        for (index, categoryInfo) in [
            ("sponsor", "–°–ø–æ–Ω—Å–æ—Ä—Å–∫–∏–µ —Å–µ–≥–º–µ–Ω—Ç—ã"),
            ("intro", "–í—Å—Ç—É–ø–ª–µ–Ω–∏—è"),
            ("outro", "–ö–æ–Ω—Ü–æ–≤–∫–∏"),
            ("interaction", "–ü—Ä–∏–∑—ã–≤—ã –∫ –¥–µ–π—Å—Ç–≤–∏—é"),
            ("selfpromo", "–°–∞–º–æ—Ä–µ–∫–ª–∞–º—ã")
        ].enumerated() {
            if let categoryStack = skipCategoriesStackView.arrangedSubviews[safe: index] as? UIStackView,
               let switchControl = categoryStack.arrangedSubviews.last as? UISwitch,
               switchControl.isOn {
                selectedCategories.append(categoryInfo.0)
            }
        }
        settings.skipCategories = selectedCategories
    }
    
    // MARK: - Status Updates
    private func updateConnectionStatus(_ status: YouTubeTVManager.ConnectionStatus) {
        switch status {
        case .disconnected:
            statusLabel.text = "–ù–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º"
            statusLabel.textColor = .systemGray
            
        case .scanning:
            statusLabel.text = "–ü–æ–∏—Å–∫ —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –≤ —Å–µ—Ç–∏..."
            statusLabel.textColor = .systemOrange
            
        case .connecting:
            statusLabel.text = "–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ YouTube TV..."
            statusLabel.textColor = .systemBlue
            
        case .connected:
            statusLabel.text = "‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ YouTube TV"
            statusLabel.textColor = .systemGreen
            updateStatistics()
            
        case .error(let message):
            statusLabel.text = "‚ùå –û—à–∏–±–∫–∞: \(message)"
            statusLabel.textColor = .systemRed
        }
    }
    
    private func updateStatistics() {
        skippedCountLabel.text = "–ü—Ä–æ–ø—É—â–µ–Ω–æ —Å–µ–≥–º–µ–Ω—Ç–æ–≤: \(skippedSegments)"
        
        let minutes = timeSaved / 60
        let hours = minutes / 60
        
        let timeText: String
        if hours > 0 {
            let remainingMinutes = minutes % 60
            timeText = "\(hours)—á \(remainingMinutes)–º–∏–Ω"
        } else {
            timeText = "\(minutes) –º–∏–Ω"
        }
        
        savedTimeLabel.text = "–°—ç–∫–æ–Ω–æ–º–ª–µ–Ω–æ –≤—Ä–µ–º–µ–Ω–∏: \(timeText)"
    }
    
    private func updateDevicesList(_ devices: [YouTubeTVDevice]) {
        // Clear existing device views
        devicesStackView.arrangedSubviews.forEach { $0.removeFromSuperview() }
        
        if devices.isEmpty {
            let noDevicesLabel = UILabel()
            noDevicesLabel.text = "–ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤"
            noDevicesLabel.textColor = .systemGray
            noDevicesLabel.font = UIFont.systemFont(ofSize: 16)
            devicesStackView.addArrangedSubview(noDevicesLabel)
        } else {
            for device in devices {
                let deviceView = createDeviceView(device: device)
                devicesStackView.addArrangedSubview(deviceView)
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω–æ–µ –≤–∏–¥–µ–æ –µ—Å–ª–∏ –µ—Å—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–Ω—ã–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
            if let connectedDevice = devices.first(where: { $0.isConnected }) {
                updateActiveVideo(for: connectedDevice)
            }
        }
    }
    
    private func updateActiveVideo(for device: YouTubeTVDevice) {
        // –≠–º—É–ª–∏—Ä—É–µ–º –ø–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ç–µ–∫—É—â–µ–º –≤–∏–¥–µ–æ
        youTubeTVManager.checkSponsorSegments(videoId: "dQw4w9WgXcQ") { [weak self] segments in
            if segments.isEmpty {
                self?.activeVideoLabel.text = "–¢–µ–∫—É—â–µ–µ –≤–∏–¥–µ–æ: –ù–µ—Ç —Å–ø–æ–Ω—Å–æ—Ä—Å–∫–∏—Ö —Å–µ–≥–º–µ–Ω—Ç–æ–≤"
            } else {
                self?.activeVideoLabel.text = "–¢–µ–∫—É—â–µ–µ –≤–∏–¥–µ–æ: –ù–∞–π–¥–µ–Ω–æ \(segments.count) —Å–µ–≥–º–µ–Ω—Ç–æ–≤ –¥–ª—è –ø—Ä–æ–ø—É—Å–∫–∞"
            }
        }
    }
    
    private func createDeviceView(device: YouTubeTVDevice) -> UIView {
        let containerView = UIView()
        containerView.backgroundColor = .systemGray6
        containerView.layer.cornerRadius = 8
        containerView.translatesAutoresizingMaskIntoConstraints = false
        
        let nameLabel = UILabel()
        nameLabel.text = device.name
        nameLabel.font = UIFont.boldSystemFont(ofSize: 16)
        nameLabel.translatesAutoresizingMaskIntoConstraints = false
        
        let modelLabel = UILabel()
        modelLabel.text = device.model ?? "YouTube TV"
        modelLabel.font = UIFont.systemFont(ofSize: 14)
        modelLabel.textColor = .systemGray
        modelLabel.translatesAutoresizingMaskIntoConstraints = false
        
        let statusIndicator = UIView()
        statusIndicator.layer.cornerRadius = 6
        statusIndicator.backgroundColor = device.isConnected ? .systemGreen : .systemGray
        statusIndicator.translatesAutoresizingMaskIntoConstraints = false
        
        let statusLabel = UILabel()
        statusLabel.text = device.isConnected ? "–ü–æ–¥–∫–ª—é—á–µ–Ω–æ" : "–ù–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ"
        statusLabel.font = UIFont.systemFont(ofSize: 14)
        statusLabel.textColor = device.isConnected ? .systemGreen : .systemGray
        statusLabel.translatesAutoresizingMaskIntoConstraints = false
        
        let ipLabel = UILabel()
        ipLabel.text = device.ipAddress
        ipLabel.font = UIFont.systemFont(ofSize: 12)
        ipLabel.textColor = .systemGray2
        ipLabel.translatesAutoresizingMaskIntoConstraints = false
        
        containerView.addSubview(nameLabel)
        containerView.addSubview(modelLabel)
        containerView.addSubview(statusIndicator)
        containerView.addSubview(statusLabel)
        containerView.addSubview(ipLabel)
        
        NSLayoutConstraint.activate([
            containerView.heightAnchor.constraint(equalToConstant: 90),
            
            nameLabel.topAnchor.constraint(equalTo: containerView.topAnchor, constant: 12),
            nameLabel.leadingAnchor.constraint(equalTo: containerView.leadingAnchor, constant: 16),
            nameLabel.trailingAnchor.constraint(equalTo: statusIndicator.leadingAnchor, constant: -8),
            
            modelLabel.topAnchor.constraint(equalTo: nameLabel.bottomAnchor, constant: 4),
            modelLabel.leadingAnchor.constraint(equalTo: containerView.leadingAnchor, constant: 16),
            modelLabel.trailingAnchor.constraint(equalTo: statusIndicator.leadingAnchor, constant: -8),
            
            ipLabel.topAnchor.constraint(equalTo: modelLabel.bottomAnchor, constant: 4),
            ipLabel.leadingAnchor.constraint(equalTo: containerView.leadingAnchor, constant: 16),
            ipLabel.trailingAnchor.constraint(equalTo: statusIndicator.leadingAnchor, constant: -8),
            
            statusIndicator.centerYAnchor.constraint(equalTo: containerView.centerYAnchor, constant: -10),
            statusIndicator.trailingAnchor.constraint(equalTo: containerView.trailingAnchor, constant: -16),
            statusIndicator.widthAnchor.constraint(equalToConstant: 12),
            statusIndicator.heightAnchor.constraint(equalToConstant: 12),
            
            statusLabel.topAnchor.constraint(equalTo: statusIndicator.bottomAnchor, constant: 4),
            statusLabel.trailingAnchor.constraint(equalTo: containerView.trailingAnchor, constant: -16)
        ])
        
        return containerView
    }
    
    // MARK: - Settings
    private func loadSettings() {
        let defaults = UserDefaults.standard
        autoSkipSwitch.isOn = defaults.bool(forKey: "autoSkipEnabled")
        muteAdsSwitch.isOn = defaults.bool(forKey: "muteAdsEnabled")
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
        let savedCategories = defaults.stringArray(forKey: "skipCategories") ?? ["sponsor", "intro", "outro", "interaction", "selfpromo"]
        
        for (index, categoryInfo) in [
            ("sponsor", "–°–ø–æ–Ω—Å–æ—Ä—Å–∫–∏–µ —Å–µ–≥–º–µ–Ω—Ç—ã"),
            ("intro", "–í—Å—Ç—É–ø–ª–µ–Ω–∏—è"),
            ("outro", "–ö–æ–Ω—Ü–æ–≤–∫–∏"),
            ("interaction", "–ü—Ä–∏–∑—ã–≤—ã –∫ –¥–µ–π—Å—Ç–≤–∏—é"),
            ("selfpromo", "–°–∞–º–æ—Ä–µ–∫–ª–∞–º—ã")
        ].enumerated() {
            if let categoryStack = skipCategoriesStackView.arrangedSubviews[safe: index] as? UIStackView,
               let switchControl = categoryStack.arrangedSubviews.last as? UISwitch {
                switchControl.isOn = savedCategories.contains(categoryInfo.0)
            }
        }
    }
    
    private func saveSettings() {
        let defaults = UserDefaults.standard
        defaults.set(autoSkipSwitch.isOn, forKey: "autoSkipEnabled")
        defaults.set(muteAdsSwitch.isOn, forKey: "muteAdsEnabled")
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
        var selectedCategories: [String] = []
        for (index, categoryInfo) in [
            ("sponsor", "–°–ø–æ–Ω—Å–æ—Ä—Å–∫–∏–µ —Å–µ–≥–º–µ–Ω—Ç—ã"),
            ("intro", "–í—Å—Ç—É–ø–ª–µ–Ω–∏—è"),
            ("outro", "–ö–æ–Ω—Ü–æ–≤–∫–∏"),
            ("interaction", "–ü—Ä–∏–∑—ã–≤—ã –∫ –¥–µ–π—Å—Ç–≤–∏—é"),
            ("selfpromo", "–°–∞–º–æ—Ä–µ–∫–ª–∞–º—ã")
        ].enumerated() {
            if let categoryStack = skipCategoriesStackView.arrangedSubviews[safe: index] as? UIStackView,
               let switchControl = categoryStack.arrangedSubviews.last as? UISwitch,
               switchControl.isOn {
                selectedCategories.append(categoryInfo.0)
            }
        }
        defaults.set(selectedCategories, forKey: "skipCategories")
    }
    
    // MARK: - Helper Methods
    private func showAlert(title: String, message: String) {
        let alert = UIAlertController(title: title, message: message, preferredStyle: .alert)
        alert.addAction(UIAlertAction(title: "OK", style: .default))
        present(alert, animated: true)
    }
}

// MARK: - Extensions
extension Array {
    subscript(safe index: Index) -> Element? {
        return indices.contains(index) ? self[index] : nil
    }
} 