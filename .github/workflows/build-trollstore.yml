name: Build TrollStore IPA

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Make scripts executable
        run: |
          chmod +x create_project.sh
          chmod +x create_entitlements.sh
        
      - name: Explore repository structure
        run: |
          echo "Current directory:"
          pwd
          echo -e "\nRoot directory contents:"
          ls -la
          echo -e "\nSearch for Xcode project files (deep):"
          find . -name "*.xcodeproj" | sort
          echo -e "\nSearch for Xcode workspace files (deep):"
          find . -name "*.xcworkspace" | sort
          echo -e "\nDirectory structure (2 levels):"
          find . -type d -maxdepth 2 | sort
          echo -e "\nCheck iSponsorBlockTV directory contents:"
          ls -la iSponsorBlockTV/ || echo "Directory not found"

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Create basic Xcode project if not found
        run: |
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ Xcode –ø—Ä–æ–µ–∫—Ç
          if [ ! -d "./iSponsorBlockTV.xcodeproj" ] && [ ! -d "./iSponsorBlockTV/iSponsorBlockTV.xcodeproj" ]; then
            echo "–°–æ–∑–¥–∞–µ–º –±–∞–∑–æ–≤—ã–π Xcode –ø—Ä–æ–µ–∫—Ç..."
            ./create_project.sh
            echo "–ë–∞–∑–æ–≤—ã–π Xcode –ø—Ä–æ–µ–∫—Ç —Å–æ–∑–¥–∞–Ω —É—Å–ø–µ—à–Ω–æ"
          else
            echo "Xcode –ø—Ä–æ–µ–∫—Ç —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"
          fi

      - name: Create entitlements file
        run: |
          # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ entitlements –∏–ª–∏ —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–µ
          if [ -f "iSponsorBlockTV/TrollStore.entitlements" ]; then
            echo "–ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —Ñ–∞–π–ª entitlements"
          else
            echo "–°–æ–∑–¥–∞–µ–º —Ñ–∞–π–ª entitlements"
            ./create_entitlements.sh
          fi
          
      - name: Debug project settings
        run: |
          if [ -d "./iSponsorBlockTV.xcodeproj" ]; then
            PROJECT_PATH="./iSponsorBlockTV.xcodeproj"
          elif [ -d "./iSponsorBlockTV/iSponsorBlockTV.xcodeproj" ]; then
            PROJECT_PATH="./iSponsorBlockTV/iSponsorBlockTV.xcodeproj"
          else
            echo "‚ùå –ü—Ä–æ–µ–∫—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω"
            exit 1
          fi
          
          echo "üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –ø—Ä–æ–µ–∫—Ç–∞:"
          echo "PROJECT_PATH: $PROJECT_PATH"
          
          # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–±–æ—Ä–∫–∏
          xcodebuild -project "$PROJECT_PATH" -scheme "iSponsorBlockTV" -configuration Release -showBuildSettings | grep -E "(SWIFT_|OPTIMIZATION|COMPILATION)" || echo "–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"
          
      - name: Build TrollStore IPA
        run: |
          # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø—É—Ç—å –∫ –ø—Ä–æ–µ–∫—Ç—É
          if [ -d "./iSponsorBlockTV.xcodeproj" ]; then
            PROJECT_PATH="./iSponsorBlockTV.xcodeproj"
          elif [ -d "./iSponsorBlockTV/iSponsorBlockTV.xcodeproj" ]; then
            PROJECT_PATH="./iSponsorBlockTV/iSponsorBlockTV.xcodeproj"
          else
            echo "–û—à–∏–±–∫–∞: –ù–µ —É–¥–∞–µ—Ç—Å—è –Ω–∞–π—Ç–∏ Xcode –ø—Ä–æ–µ–∫—Ç"
            exit 1
          fi
          
          SCHEME_NAME="iSponsorBlockTV"
          
          echo "–ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–æ–µ–∫—Ç: $PROJECT_PATH"
          echo "–ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ö–µ–º—É: $SCHEME_NAME"
          
          # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–æ—Å—Ç—É–ø–Ω—ã–µ —Å—Ö–µ–º—ã
          xcodebuild -project "$PROJECT_PATH" -list || echo "–ù–µ —É–¥–∞–µ—Ç—Å—è –ø–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Å—Ö–µ–º"
          
          # –°–æ–∑–¥–∞–µ–º –ø–∞–ø–∫—É –¥–ª—è —Å–±–æ—Ä–∫–∏
          mkdir -p build
          
          # –°–±–æ—Ä–∫–∞ –∞—Ä—Ö–∏–≤–∞
          echo "–ù–∞—á–∏–Ω–∞–µ–º —Å–±–æ—Ä–∫—É –∞—Ä—Ö–∏–≤–∞..."
          xcodebuild clean archive \
            -project "$PROJECT_PATH" \
            -scheme "$SCHEME_NAME" \
            -configuration Release \
            -sdk iphoneos \
            -archivePath build/app.xcarchive \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGN_IDENTITY="" \
            PROVISIONING_PROFILE="" \
            DEVELOPMENT_TEAM="" \
            PRODUCT_BUNDLE_IDENTIFIER="com.elchin91.isponsorblockTV" \
            ENABLE_BITCODE=NO \
            STRIP_SWIFT_SYMBOLS=NO \
            COPY_PHASE_STRIP=NO \
            VALID_ARCHS="arm64" \
            ARCHS="arm64" \
            ONLY_ACTIVE_ARCH=NO \
            ALWAYS_EMBED_SWIFT_STANDARD_LIBRARIES=YES \
            SWIFT_COMPILATION_MODE="wholemodule" \
            SWIFT_OPTIMIZATION_LEVEL="-O" \
            ENABLE_PREVIEWS=NO \
            | tee build.log
            
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Å–±–æ—Ä–∫–∏
          if [ ${PIPESTATUS[0]} -ne 0 ]; then
            echo "–û—à–∏–±–∫–∞ —Å–±–æ—Ä–∫–∏. –õ–æ–≥:"
            cat build.log
            exit 1
          fi
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –∏—Å–ø–æ–ª–Ω—è–µ–º—ã–π —Ñ–∞–π–ª —Å–æ–∑–¥–∞–ª—Å—è
          APP_PATH=$(find build/app.xcarchive/Products/Applications -name "*.app" | head -1)
          if [ -n "$APP_PATH" ]; then
            echo "–ù–∞–π–¥–µ–Ω–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ: $APP_PATH"
            ls -la "$APP_PATH"
            EXECUTABLE_PATH="$APP_PATH/iSponsorBlockTV"
            if [ -f "$EXECUTABLE_PATH" ]; then
              echo "‚úÖ –ò—Å–ø–æ–ª–Ω—è–µ–º—ã–π —Ñ–∞–π–ª –Ω–∞–π–¥–µ–Ω: $EXECUTABLE_PATH"
              file "$EXECUTABLE_PATH"
            else
              echo "‚ùå –ò—Å–ø–æ–ª–Ω—è–µ–º—ã–π —Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ $EXECUTABLE_PATH"
              echo "–°–æ–¥–µ—Ä–∂–∏–º–æ–µ app bundle:"
              ls -la "$APP_PATH"
            fi
          fi
            
      - name: Create IPA
        run: |
          if [ -d "build/app.xcarchive/Products/Applications" ]; then
            echo "–ê—Ä—Ö–∏–≤ —Å–æ–∑–¥–∞–Ω —É—Å–ø–µ—à–Ω–æ. –°–æ–∑–¥–∞–µ–º IPA..."
            mkdir -p Payload
            cp -r build/app.xcarchive/Products/Applications/*.app Payload/
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ø–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º IPA
            echo "–°—Ç—Ä—É–∫—Ç—É—Ä–∞ Payload:"
            find Payload -type f | head -20
            
            zip -r iSponsorBlockTV-TrollStore.ipa Payload
            echo "IPA —Å–æ–∑–¥–∞–Ω –≤: iSponsorBlockTV-TrollStore.ipa"
            ls -la iSponsorBlockTV-TrollStore.ipa
          else
            echo "–ê—Ä—Ö–∏–≤ –Ω–µ —Å–æ–∑–¥–∞–Ω. –ù–µ —É–¥–∞–µ—Ç—Å—è —Å–æ–∑–¥–∞—Ç—å IPA."
            echo "–°–æ–¥–µ—Ä–∂–∏–º–æ–µ –ø–∞–ø–∫–∏ build:"
            find build -type f | head -20
            exit 1
          fi

      - name: Upload IPA as artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: iSponsorBlockTV-TrollStore-IPA
          path: iSponsorBlockTV-TrollStore.ipa
          retention-days: 30
